blocks:
  # Copy servers.yaml from current directory to storage (if it exists)
  - run: mkdir -p ./storage && cp ./servers.yaml ./storage/servers.yaml

  # Initialize health check environment
  - run: mkdir -p ./health_reports


  # Sequential health checks for all servers with loop iteration
  # Stream logs in real-time: tail -f ./health_reports/*_health.log
  - for:
      individual: server
      in: ${servers.all_servers}
      run-remotely:
        ip: ${server.ip}
        user: ${server.username}
        pass: ${server.password}
        run: |
          echo "=== Health Check Report for ${server.ip} ==="
          echo ""
          echo "--- System Information ---"
          uname -a
          echo ""
          echo "--- Uptime ---"
          uptime
          echo ""
          echo "--- Memory Usage ---"
          free -h
          echo ""
          echo "--- Disk Usage ---"
          df -h
          echo ""
          echo "--- CPU Information ---"
          lscpu | grep -E 'Model name|CPU\(s\)|Thread|Core'
          echo ""
          echo "--- Load Average ---"
          cat /proc/loadavg
          echo ""
          echo "--- Running Processes (Top 10 by Memory) ---"
          ps aux --sort=-%mem | head -11
          echo ""
          echo "--- Network Interfaces ---"
          ip addr show | grep -E 'inet |link/ether'
          echo ""
          echo "--- Active Network Connections ---"
          netstat -tuln | head -20
          echo ""
          echo "=== Health Check Complete ==="
        log-into: ./health_reports/${server.ip}_health.log


  - run: echo 'Health checkups concluded'
  - run: rm -rf .git .gitignore main.yaml README.md run_health_check.ps1 run_health_check.sh servers.yaml.example storage
