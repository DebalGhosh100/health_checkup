blocks:
  # Initialize health check environment
  - run: "mkdir -p ./health_reports && echo 'Health check reports directory created'"

  # Display health check start banner
  - run: |
      echo "============================================"
      echo "   System Health Check - Starting"
      echo "   Time: $(date)"
      echo "============================================"

  # Sequential health checks for all servers with loop iteration
  # Stream logs in real-time: tail -f ./health_reports/*_health.log
  - for:
      individual: server
      in: ${servers.all_servers}
      run-remotely:
        ip: ${server.ip}
        user: ${server.username}
        pass: ${server.password}
        run: |
          echo "=== Health Check Report for ${server.name} ==="
          echo "Timestamp: $(date)"
          echo ""
          echo "--- System Information ---"
          uname -a
          echo ""
          echo "--- Uptime ---"
          uptime
          echo ""
          echo "--- Memory Usage ---"
          free -h
          echo ""
          echo "--- Disk Usage ---"
          df -h
          echo ""
          echo "--- CPU Information ---"
          lscpu | grep -E 'Model name|CPU\(s\)|Thread|Core'
          echo ""
          echo "--- Load Average ---"
          cat /proc/loadavg
          echo ""
          echo "--- Running Processes (Top 10 by Memory) ---"
          ps aux --sort=-%mem | head -11
          echo ""
          echo "--- Network Interfaces ---"
          ip addr show | grep -E 'inet |link/ether'
          echo ""
          echo "--- Active Network Connections ---"
          netstat -tuln | head -20
          echo ""
          echo "=== Health Check Complete ==="
        log-into: ./health_reports/${server.ip}_health.log

  # Parallel health checks for critical services across all servers
  # Monitor all checks simultaneously: tail -f ./health_reports/*_services.log
  - parallel:
      for:
        individual: server
        in: ${servers.all_servers}
        run-remotely:
          ip: ${server.ip}
          user: ${server.username}
          pass: ${server.password}
          run: |
            echo "=== Service Status Check for ${server.name} ==="
            echo "Timestamp: $(date)"
            echo ""
            echo "--- Checking Critical Services ---"
            for service in ${services.critical_services}; do
              echo "Checking: $service"
              if systemctl is-active --quiet $service 2>/dev/null; then
                echo "  ✓ $service is RUNNING"
              else
                echo "  ✗ $service is NOT RUNNING or NOT FOUND"
              fi
            done
            echo ""
            echo "--- Docker Status (if installed) ---"
            if command -v docker &> /dev/null; then
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "Docker daemon not running"
            else
              echo "Docker not installed"
            fi
            echo ""
            echo "=== Service Check Complete ==="
          log-into: ./health_reports/${server.ip}_services.log

  # Generate summary report
  - run: |
      echo ""
      echo "============================================"
      echo "   Health Check Summary"
      echo "============================================"
      echo ""
      echo "Reports generated in ./health_reports/"
      echo ""
      echo "Available reports:"
      ls -lh ./health_reports/
      echo ""
      echo "--- Quick Summary ---"
      echo "Total servers checked: $(ls ./health_reports/*_health.log 2>/dev/null | wc -l)"
      echo ""
      echo "To view individual reports:"
      echo "  cat ./health_reports/<ip>_health.log"
      echo "  cat ./health_reports/<ip>_services.log"
      echo ""
      echo "Health check completed at: $(date)"
      echo "============================================"
